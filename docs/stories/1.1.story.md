# Story 1.1: Physics Engine Integration

## Status
Draft

## Story

**As a** developer,
**I want** to integrate Matter.js physics engine with the existing react-konva canvas system,
**so that** canvas objects can have realistic physics properties and collision detection.

## Acceptance Criteria

1. Matter.js is installed and configured with react-konva using the specified engine configuration
2. Existing canvas objects can be converted to physics bodies using the defined obstacle configuration
3. Physics engine runs independently from canvas mode with 60fps target (16.666ms delta)
4. Basic collision detection is working between objects with proper restitution and friction settings
5. Physics calculations don't interfere with existing canvas operations
6. Physics engine can be initialized and destroyed without affecting canvas state
7. Collision events are properly detected and logged for debugging

## Tasks / Subtasks

- [ ] Task 1: Install and Configure Matter.js (AC: 1)
  - [ ] Install matter-js package using Bun
  - [ ] Install @types/matter-js for TypeScript support
  - [ ] Create physics engine configuration file with specified settings
  - [ ] Set up engine with zero gravity and 60fps timing (16.666ms delta)

- [ ] Task 2: Create Physics Service Layer (AC: 2, 3, 5, 6)
  - [ ] Create lib/physics/PhysicsEngine.ts service class
  - [ ] Implement engine initialization and destruction methods
  - [ ] Create physics body creation methods for different object types
  - [ ] Implement physics loop with 60fps target timing
  - [ ] Add proper cleanup and memory management

- [ ] Task 3: Integrate with Canvas Objects (AC: 2, 4)
  - [ ] Extend CanvasObject type to include physics body reference
  - [ ] Create conversion methods from Konva shapes to Matter.js bodies
  - [ ] Implement obstacle configuration (restitution: 0.8, friction: 0.1, isStatic: true)
  - [ ] Add physics body synchronization with Konva shapes

- [ ] Task 4: Implement Collision Detection (AC: 4, 7)
  - [ ] Set up collision event listeners in Matter.js engine
  - [ ] Create collision handler service for different collision types
  - [ ] Implement proper restitution and friction settings
  - [ ] Add collision event logging and debugging

- [ ] Task 5: Integration Testing (AC: 5, 6)
  - [ ] Test physics engine initialization doesn't affect canvas mode
  - [ ] Verify existing canvas operations continue working normally
  - [ ] Test physics engine can be disabled without side effects
  - [ ] Validate performance impact is minimal

## Dev Notes

### Previous Story Insights:
- This is the first story in Epic 1, so no previous story context
- Existing canvas system uses react-konva with service layer pattern
- Canvas operations are handled through CanvasOperations service class

### Data Models:
- **CanvasObject Interface**: [Source: types/canvas.ts] - Existing interface with id, type, x, y, width, height, color, rotation, owner, created_by
- **Physics Body Extension**: Need to extend CanvasObject to include physics body reference
- **Game Properties**: [Source: docs/prd/technical-constraints-and-integration-requirements.md] - JSONB column for game_properties

### API Specifications:
- **CanvasOperations Service**: [Source: lib/canvas/CanvasOperations.ts] - Existing service for canvas object CRUD operations
- **Service Layer Pattern**: [Source: memory-bank/systemPatterns.md] - Follow existing service layer pattern for physics operations
- **Real-time Events**: [Source: docs/prd/technical-constraints-and-integration-requirements.md] - GameRealtimeEvents interface for physics events

### Component Specifications:
- **Canvas Components**: [Source: memory-bank/systemPatterns.md] - Canvas.tsx, CanvasStage.tsx, Rectangle.tsx, Ellipse.tsx
- **React-Konva Integration**: [Source: memory-bank/techContext.md] - Use react-konva components with Konva.js
- **Component Organization**: [Source: memory-bank/techContext.md] - Follow components/canvas/ structure

### File Locations:
- **Physics Service**: lib/physics/PhysicsEngine.ts (new)
- **Physics Types**: types/physics.ts (new)
- **Physics Hooks**: hooks/usePhysics.ts (new)
- **Physics Components**: components/physics/ (new directory)

### Testing Requirements:
- **Test Location**: tests/physics/ (new directory)
- **Test Framework**: Follow existing testing patterns
- **Unit Tests**: PhysicsEngine service methods
- **Integration Tests**: Physics integration with canvas operations
- **Performance Tests**: 60fps physics loop validation

### Technical Constraints:
- **Matter.js Configuration**: [Source: docs/prd/technical-constraints-and-integration-requirements.md]
  - Engine: gravity: {x: 0, y: 0}, delta: 16.666ms (60fps)
  - Obstacle bodies: restitution: 0.8, friction: 0.1, isStatic: true
- **Performance**: [Source: memory-bank/systemPatterns.md] - Maintain existing performance patterns
- **TypeScript**: [Source: memory-bank/techContext.md] - Full type safety throughout
- **Build Process**: [Source: memory-bank/techContext.md] - Use Bun package manager

### Testing

#### Testing Standards:
- **Test File Location**: tests/physics/ directory
- **Test Framework**: Follow existing project testing patterns
- **Unit Testing**: Test PhysicsEngine service methods individually
- **Integration Testing**: Test physics integration with existing canvas operations
- **Performance Testing**: Validate 60fps physics loop performance
- **Memory Testing**: Ensure proper cleanup and no memory leaks

#### Specific Testing Requirements:
- Test physics engine initialization and destruction
- Test collision detection accuracy
- Test performance impact on existing canvas operations
- Test physics body synchronization with Konva shapes
- Test collision event logging and debugging

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| Current | 1.0 | Initial story creation from PRD | Product Manager John |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
